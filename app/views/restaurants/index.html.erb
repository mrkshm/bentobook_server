<h1 class="text-4xl my-4 font-bold text-surface-700"><%= t('restaurants.index.title') %></h1>

<% flash.each do |type, message| %>
  <div class="px-4 py-3 rounded-lg mb-4 <%= type == 'notice' ? 'bg-primary-100 text-primary-700' : 'bg-error-100 text-error-700' %>">
    <%= message %>
  </div>
<% end %>

<% if params[:tag].present? %>
  <div class="px-4 py-3 rounded-lg mb-4 bg-primary-100 text-primary-700">
    Showing restaurants tagged with "<%= params[:tag] %>"
  </div>
<% end %>

<div class="mb-4">
  <%= link_to t('restaurants.create_restaurant_button'), new_restaurant_path, class: 'inline-flex items-center px-4 py-2 bg-primary-600 text-surface-50 font-medium rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors' %>
</div>

<div class="mb-4 flex flex-col md:flex-row justify-between items-end gap-4">
  <form action="<%= restaurants_path %>" method="get" class="w-full md:w-auto" id="sort-form"
      x-data="{ 
        coords: { lat: null, lng: null },
        async getLocation(event) {
          if (event?.target === this.$refs.sortSelect) {
            this.$refs.orderAsc.value = 'asc';
          }
          
          if (this.$refs.sortSelect.value === 'distance') {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject);
              });
              
              this.$refs.latInput.value = position.coords.latitude;
              this.$refs.lngInput.value = position.coords.longitude;
              
              this.coords = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              
              this.$refs.form.submit();
            } catch (error) {
              console.error('Location error:', error);
              alert('Could not get your location. Please enable location services.');
              this.$refs.sortSelect.value = 'name';
              this.$refs.form.submit();
            }
          } else {
            this.$refs.form.submit();
          }
        }
      }"
      @submit.prevent="getLocation($event)"
      x-ref="form">
    <input type="hidden" name="search" value="<%= params[:search] %>">
    <input type="hidden" name="latitude" x-ref="latInput">
    <input type="hidden" name="longitude" x-ref="lngInput">
    <input type="hidden" name="order_direction" value="<%= params[:order_direction] || 'asc' %>" x-ref="orderAsc">
    <div class="w-full">
      <label for="sort-select" class="block text-sm font-medium text-surface-700 mb-1">
        <%= t('restaurants.index.sort_by') %>
      </label>
      <div class="flex gap-2 items-center">
        <select id="sort-select" name="order_by" 
                class="block w-full md:w-64 px-3 py-2 bg-surface-50 border border-surface-300 rounded-lg shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-primary-500" 
                x-ref="sortSelect"
                @change="getLocation($event)">
          <% [['name', t("restaurants.search_by.name")],
          ['created_at', t("restaurants.search_by.created_at")],
          ['updated_at', t("restaurants.search_by.updated_at")],
          ['distance', t("restaurants.search_by.distance")]].each do |value, label| %>
            <option value="<%= value %>" <%= 'selected' if params[:order_by] == value %>><%= label %></option>
          <% end %>
        </select>
        <div class="flex gap-1">
          <button type="submit" name="order_direction" value="asc" 
                  class="p-2 rounded-lg hover:bg-surface-100 transition-colors <%= params[:order_direction] != 'desc' ? 'bg-surface-100' : '' %>">
            <%= heroicon "arrow-down", options: { class: "w-5 h-5" } %>
          </button>
          <button type="submit" name="order_direction" value="desc" 
                  class="p-2 rounded-lg hover:bg-surface-100 transition-colors <%= params[:order_direction] == 'desc' ? 'bg-surface-100' : '' %>">
            <%= heroicon "arrow-up", options: { class: "w-5 h-5" } %>
          </button>
        </div>
      </div>
    </div>
  </form>

  <%= form_tag restaurants_path, method: :get, class: 'w-full md:w-1/2', id: 'search-form' do %>
    <div class="flex flex-col md:flex-row items-end gap-2">
      <div class="w-full">
        <label for="search-input" class="block text-sm font-medium text-surface-700 mb-1">
          <%= t('search') %>:
        </label>
        <div class="flex gap-2">
          <input type="text" id="search-input" name="search" value="<%= params[:search] %>" 
                 class="block w-full px-3 py-2 bg-surface-50 border border-surface-300 rounded-lg shadow-sm focus:outline-none focus:ring-1 focus:ring-primary-500 focus:border-primary-500" 
                 placeholder=<%= t('restaurants.index.search_restaurants_placeholder') %>>
          <%= submit_tag t("search"), class: 'px-4 py-2 bg-primary-600 text-surface-50 font-medium rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors whitespace-nowrap' %>
          <%= button_tag t("reset"), type: 'button', 
              class: 'px-4 py-2 text-surface-700 bg-surface-50 border border-surface-300 rounded-lg hover:bg-surface-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-surface-500 transition-colors whitespace-nowrap', 
              onclick: "window.location='#{restaurants_path}'" %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<% if @restaurants.empty? %>
    <p class="text-surface-600 text-center py-8"><%= t('restaurants.index.no_restaurants_found') %></p>
<% else %>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-start">
    <% @restaurants.each do |restaurant| %>
      <div class="w-full">
        <%= render(RestaurantCardComponent.new(restaurant: restaurant)) %>
      </div>
    <% end %>
  </div>
  <div class="flex flex-col items-center space-y-4 mt-8">
    <nav class="flex items-center space-x-2" role="navigation" aria-label="Pagination">
      <%== pagy_nav(@pagy) %>
    </nav>
    <div class="text-sm text-surface-600 bg-surface-100 px-4 py-2 rounded-lg">
      <%== pagy_info(@pagy) %>
    </div>
  </div>
<% end %>
